name: Docker Image CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image_base: [alpine3.12, buster]
    env: 
      VERSION: "2020.10"
      VARIANT: ${{ matrix.image_base }}
    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build . --file $VERSION/$VARIANT/Dockerfile --tag $GITHUB_REPOSITORY:$GITHUB_SHA
    - name: Test docker image with root
      run: docker run --rm rakudo-star:latest zef list --installed && docker run --rm rakudo-star:latest raku -e 'say $*VM.version'
    - name: Test docker image with raku
      run: docker run --rm --user raku rakudo-star:latest zef list --installed && docker run --rm --user raku rakudo-star:latest raku -e 'say $*VM.version'
